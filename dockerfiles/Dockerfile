FROM node:14.4-alpine

RUN mkdir -p home/app
WORKDIR /home/app

COPY ./temp ./

ARG NPM_CREDENTIALS
ENV NPM_CREDENTIALS=$NPM_CREDENTIALS

RUN ./create-npmrc.sh $NPM_CREDENTIALS

RUN yarn bootstrap

COPY ./packages ./packages

ARG BUILD_ENV_PARAM
ENV BUILD_ENV_PARAM=$BUILD_ENV_PARAM

ARG WITH_ONE_LOGIN=false
ARG OIDC_CLIENT_ID=""
ARG OIDC_CLIENT_SECRET=""
ARG IDENTITY_CLIENT_ID
ARG IDENTITY_CLIENT_SECRET
ARG WEB_HOOKS_SECRET

ARG POSTGRES_HOST=localhost
ARG POSTGRES_PORT=5432
ARG POSTGRES_DB
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD

# -- SERVER --
# general
ENV NODE_PORT=9000
ENV NODE_ENV=ppe
ENV APPLICATION_PATH="/"


# client
ENV COOKIE_SESSION_KEY=dni-cookie
ENV COOKIE_USER_KEY=user-data

# onelogin
ENV WITH_ONE_LOGIN=${WITH_ONE_LOGIN}

ENV OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
ENV OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}

ENV ISSUER_URL=https://loginppe.ourtesco.com/oidc/2
ENV REGISTERED_CALLBACK_URL_ROOT=http://localhost:9000
ENV REGISTERED_CALLBACK_URL_PATH=/auth/openid/callback
ENV REDIRECT_AFTER_LOGOUT_URL=https://loginppe.ourtesco.com/logout

ENV REFRESH_TOKEN_SECRET=secret

# identity
ENV IDENTITY_CLIENT_ID=${IDENTITY_CLIENT_ID}
ENV IDENTITY_CLIENT_SECRET=${IDENTITY_CLIENT_SECRET}
ENV IDENTITY_USER_SCOPED_TOKEN_COOKIE_SECRET=secret
ENV IDENTITY_USER_SCOPED_TOKEN_COOKIE_NAME=identity-user-scoped-token

# Mock server (must not be empty)
ENV MOCK_SERVER_URL=/

# Confirmit
ENV CONFIRMIT_PASSWORD=

# Notifications
ENV WEB_HOOKS_SECRET=${WEB_HOOKS_SECRET}

# PG DB
ENV POSTGRES_HOST=${POSTGRES_HOST}
ENV POSTGRES_PORT=${POSTGRES_PORT}
ENV POSTGRES_DB=${POSTGRES_DB}
ENV POSTGRES_USER=${POSTGRES_USER}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

# CMS (optional. to override cms access source)
# COLLEAGUE_CMS_URL=http://127.0.0.1:1337

# -- CLIENT --
ENV SKIP_PREFLIGHT_CHECK=true

ENV REACT_APP_API_URL=/api
ENV REACT_APP_WS_URL=/
ENV REACT_APP_API_VERSION=
#ENV PORT=4000
#ENV NODE_ENV=production
ENV REACT_APP_CONTENT_URL=

# -- DB --
# PG DB
ENV TYPEORM_TYPE=postgres
ENV TYPEORM_HOST=${POSTGRES_HOST}
ENV TYPEORM_PORT=${POSTGRES_PORT}
ENV TYPEORM_DATABASE=${POSTGRES_DB}
ENV TYPEORM_USERNAME=${POSTGRES_USER}
ENV TYPEORM_PASSWORD=${POSTGRES_PASSWORD}

ENV TYPEORM_SYNCHRONIZE=false
ENV TYPEORM_LOGGING=false

#RUN yarn ws:db migration:run

RUN yarn build:prod

CMD yarn run:prod

EXPOSE 9000
